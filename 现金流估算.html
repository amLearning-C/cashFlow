<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æµåŠ¨ç°é‡‘ - ç‚¹å‡»äº¤äº’ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4a90e2; --income: #2ecc71; --expense: #e74c3c;
            --bg: #f5f7fa; --card: #ffffff; --text: #2d3748;
            --muted: #a0aec0;
        }

        body { font-family: -apple-system, "SF Pro Text", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .container { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 310px 1fr; gap: 15px; }
        
        .panel { background: var(--card); padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); height: fit-content; }
        h3 { margin: 0 0 12px 0; font-size: 0.9em; display: flex; align-items: center; gap: 6px; border-bottom: 1px solid #edf2f7; padding-bottom: 6px; }
        
        .input-group { margin-bottom: 12px; padding: 10px; background: #f8fafc; border-radius: 8px; border: 1px solid #eee; }
        label { display: block; font-size: 11px; color: #718096; margin-bottom: 4px; font-weight: bold; }
        input { width: 100%; padding: 7px 10px; border: 1px solid #e2e8f0; border-radius: 5px; box-sizing: border-box; font-size: 13px; outline: none; }
        
        .btn-primary { width: 100%; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; margin-top: 5px; font-weight: bold;}
        .btn-outline { background: #f7fafc; border: 1px solid #e2e8f0; color: #4a5568; padding: 6px; border-radius: 5px; cursor: pointer; font-size: 11px; }

        .calendar-header { display: flex; align-items: center; justify-content: center; gap: 30px; margin-bottom: 15px; }
        .nav-arrow { background: none; border: none; font-size: 1.2em; color: var(--primary); cursor: pointer; font-weight: bold; padding: 0 10px; }
        #currentMonthLabel { font-size: 1.1em; font-weight: bold; margin: 0; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .weekday { text-align: center; color: #a0aec0; font-size: 11px; font-weight: bold; padding-bottom: 5px; }
        
        /* æ—¥å†å¡ç‰‡æ ·å¼ */
        .day-card { 
            background: white; border-radius: 6px; padding: 6px; min-height: 75px; 
            border: 1px solid #f1f5f9; position: relative; transition: 0.2s; cursor: pointer; /* é¼ æ ‡å˜ä¸ºæ‰‹å‹ */
        }
        .day-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: var(--primary); transform: translateY(-2px); }
        
        .day-card.is-history { background: #fafbfc; }
        .day-card.is-history .balance { color: var(--muted); font-weight: normal; }
        .day-card.is-history .tag { opacity: 0.4; }

        .day-card.is-anchor { border: 2px solid #5cb85c; background: #f0fff4; }
        .day-card.is-anchor::after { content: "é”šç‚¹"; position: absolute; top: 4px; right: 4px; font-size: 8px; background: #5cb85c; color: white; padding: 1px 3px; border-radius: 3px; }
        .day-card.is-today { border: 2px solid var(--primary); }
        .day-card.is-today:not(.is-anchor)::after { content: "ä»Šå¤©"; position: absolute; top: 4px; right: 4px; font-size: 8px; background: var(--primary); color: white; padding: 1px 3px; border-radius: 3px; }
        
        .date-num { font-size: 11px; color: #cbd5e0; margin-bottom: 4px; }
        .balance { font-weight: bold; font-size: 0.95em; color: #1a202c; }
        
        .tag { font-size: 10px; padding: 2px 4px; border-radius: 3px; display: block; margin-top: 3px; font-weight: bold; text-align: center; }
        .tag-plus { color: var(--income); background: rgba(46, 204, 113, 0.1); }
        .tag-minus { color: var(--expense); background: rgba(231, 76, 60, 0.1); }

        .chart-section { margin-top: 15px; background: white; padding: 15px; border-radius: 10px; height: 210px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .item-list { margin-top: 8px; max-height: 120px; overflow-y: auto; list-style: none; padding: 0; font-size: 11px; }
        .item-list li { padding: 5px 0; border-bottom: 1px solid #f7fafc; display: flex; justify-content: space-between; align-items: center; }
        .del-x { color: #ccc; cursor: pointer; padding-left: 10px; }
        
        /* å¼¹çª—æ ·å¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 100; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 320px; padding: 20px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.2s ease-out; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        .modal-title { font-weight: bold; font-size: 1.1em; }
        .close-btn { font-size: 24px; color: #999; cursor: pointer; line-height: 20px; }
        .modal-list { background: #f8fafc; border-radius: 8px; padding: 10px; margin-bottom: 15px; max-height: 150px; overflow-y: auto; }
        .modal-item { display: flex; justify-content: space-between; font-size: 13px; padding: 6px 0; border-bottom: 1px dashed #eee; }
        .modal-item:last-child { border-bottom: none; }
        .modal-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; margin-bottom: 8px; font-size: 14px; }
    </style>
</head>
<body>

<div id="dayModal" class="modal-overlay" onclick="if(event.target===this) closeModal()">
    <div class="modal-box">
        <div class="modal-header">
            <span id="modalDateTitle" class="modal-title">2025-12-01</span>
            <span class="close-btn" onclick="closeModal()">Ã—</span>
        </div>
        <div id="modalContentList" class="modal-list">
            </div>
        <div style="border-top: 1px solid #eee; padding-top: 15px;">
            <label style="margin-bottom:8px;">æ·»åŠ æ–°è®°å½• (è´Ÿæ•°ä¸ºæ”¯å‡º)</label>
            <input type="number" id="mModAmt" class="modal-input" placeholder="é‡‘é¢ (ä¾‹å¦‚: -50 æˆ– 200)">
            <input type="text" id="mModNote" class="modal-input" placeholder="å¤‡æ³¨ (ä¾‹å¦‚: å¥¶èŒ¶)">
            <button class="btn-primary" onclick="saveFromModal()">ä¿å­˜è®°å½•</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="panel">
        <h3>ğŸ“ è´¦æˆ·å¯¹è´¦é”šç‚¹</h3>
        <div class="input-group">
            <label>é”šç‚¹æ—¥æœŸ (ç¡®åˆ‡ä½™é¢æ—¥æœŸ)</label>
            <input type="date" id="baseDate" onchange="updateUI()">
            <label style="margin-top:8px;">è¯¥æ—¥çœŸå®ç»“ä½™</label>
            <input type="number" id="baseBalance" onchange="updateUI()">
        </div>

        <h3>âš™ï¸ æ—¥å¸¸å‚æ•°</h3>
        <div class="input-group">
            <label>æ¯æ—¥æ—¥å¸¸æ”¯å‡º (é¥­é’±ç­‰)</label>
            <input type="number" id="dailyFixed" onchange="updateUI()">
        </div>

        <h3>ğŸ“… æ¯æœˆå›ºå®šæ‰£æ¬¾</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom: 5px;">
            <input type="number" id="mFixedAmt" placeholder="é‡‘é¢">
            <input type="number" id="mFixedDay" placeholder="æ—¥æœŸ">
        </div>
        <input type="text" id="mFixedNote" placeholder="å¤‡æ³¨: æˆ¿ç§Ÿã€ä¿è´¹...">
        <button class="btn-primary" onclick="addItem('monthly')">æ·»åŠ å®šæœŸé¡¹</button>
        <ul id="mList" class="item-list"></ul>

        <h3>ğŸ“ éšæœºå•ç¬”æ”¶æ”¯</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom: 5px;">
            <input type="number" id="tAmt" placeholder="é‡‘é¢">
            <input type="date" id="tDate">
        </div>
        <input type="text" id="tNote" placeholder="å¤‡æ³¨: å¥–é‡‘ã€å¤–å–...">
        <button class="btn-primary" onclick="addItem('trans')">å½•å…¥ä¸€ç¬”</button>
        <ul id="tList" class="item-list"></ul>

        <div style="margin-top:15px; display:flex; gap:5px;">
            <button class="btn-outline" style="flex:1" onclick="exportData()">å¤‡ä»½</button>
            <button class="btn-outline" style="flex:1" onclick="document.getElementById('fileIn').click()">å¯¼å…¥</button>
        </div>
        <input type="file" id="fileIn" style="display:none" onchange="importData(event)">
    </div>

    <div>
        <div class="panel">
            <div class="calendar-header">
                <button class="nav-arrow" onclick="changeMonth(-1)">â®</button>
                <h2 id="currentMonthLabel">åŠ è½½ä¸­...</h2>
                <button class="nav-arrow" onclick="changeMonth(1)">â¯</button>
            </div>
            <div class="calendar-grid" id="calendar"></div>
        </div>
        <div class="chart-section">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
</div>

<script>
    const APP_VER = "5.3";
    const todayStr = new Date().toLocaleDateString('sv-SE');

    let store = JSON.parse(localStorage.getItem('cash_flow_v5')) || {
        version: APP_VER,
        config: { baseBalance: 3144, baseDate: todayStr, dailyFixed: 50 },
        monthlyFixed: [],
        transactions: []
    };

    let viewDate = new Date();
    let myChart = null;
    let currentModalDate = ""; // è®°å½•å½“å‰æ‰“å¼€å¼¹çª—çš„æ—¥æœŸ

    // --- æ ¸å¿ƒè®¡ç®— ---
    function getBalanceAtDate(targetDateStr) {
        const target = new Date(targetDateStr);
        const base = new Date(store.config.baseDate);
        const diffDays = Math.round((target - base) / (1000 * 60 * 60 * 24));
        let balance = store.config.baseBalance;
        const step = diffDays >= 0 ? 1 : -1;
        const absDays = Math.abs(diffDays);
        let tempDate = new Date(base);
        for(let i = 0; i < absDays; i++) {
            if(step === 1) {
                tempDate.setDate(tempDate.getDate() + 1);
                balance -= store.config.dailyFixed;
                const curStr = tempDate.toLocaleDateString('sv-SE');
                store.monthlyFixed.forEach(f => { if(f.day === tempDate.getDate()) balance -= f.amt; });
                store.transactions.forEach(t => { if(t.date === curStr) balance += t.amt; });
            } else {
                const curStr = tempDate.toLocaleDateString('sv-SE');
                balance += store.config.dailyFixed;
                store.monthlyFixed.forEach(f => { if(f.day === tempDate.getDate()) balance += f.amt; });
                store.transactions.forEach(t => { if(t.date === curStr) balance -= t.amt; });
                tempDate.setDate(tempDate.getDate() - 1);
            }
        }
        return balance;
    }

    function updateUI() {
        save();
        renderCalendar();
        renderChart();
        renderLists();
    }

    function save() {
        store.config.baseBalance = parseFloat(document.getElementById('baseBalance').value) || 0;
        store.config.baseDate = document.getElementById('baseDate').value;
        store.config.dailyFixed = parseFloat(document.getElementById('dailyFixed').value) || 0;
        localStorage.setItem('cash_flow_v5', JSON.stringify(store));
    }

    function renderCalendar() {
        const cal = document.getElementById('calendar');
        cal.innerHTML = '';
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        document.getElementById('currentMonthLabel').innerText = `${y}å¹´ ${m + 1}æœˆ`;
        ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => cal.innerHTML += `<div class="weekday">${d}</div>`);
        const firstDay = new Date(y, m, 1).getDay();
        const totalDays = new Date(y, m + 1, 0).getDate();
        for(let i=0; i<firstDay; i++) cal.innerHTML += `<div></div>`;

        const baseDateObj = new Date(store.config.baseDate);

        for(let d=1; d<=totalDays; d++) {
            const dateObj = new Date(y, m, d);
            const dateStr = dateObj.toLocaleDateString('sv-SE');
            const balance = getBalanceAtDate(dateStr);
            
            const isHistory = dateObj < baseDateObj;
            const isAnchor = dateStr === store.config.baseDate;
            const isToday = dateStr === todayStr;

            let netChange = 0;
            store.monthlyFixed.forEach(f => { if(f.day === d) netChange -= f.amt; });
            store.transactions.forEach(t => { if(t.date === dateStr) netChange += t.amt; });
            
            // ç‚¹å‡»äº‹ä»¶ç»‘å®š openModal
            cal.innerHTML += `
                <div class="day-card ${isHistory ? 'is-history' : ''} ${isAnchor ? 'is-anchor' : ''} ${isToday ? 'is-today' : ''}" 
                     onclick="openModal('${dateStr}')">
                    <div class="date-num">${d}</div>
                    <div class="balance">Â¥${Math.round(balance)}</div>
                    ${netChange !== 0 ? `<span class="tag ${netChange > 0 ? 'tag-plus' : 'tag-minus'}">${netChange > 0 ? '+' : ''}${netChange}</span>` : ''}
                </div>
            `;
        }
    }

    // --- å¼¹çª—é€»è¾‘ ---
    function openModal(dateStr) {
        currentModalDate = dateStr;
        document.getElementById('modalDateTitle').innerText = dateStr;
        document.getElementById('mModAmt').value = '';
        document.getElementById('mModNote').value = '';
        renderModalList();
        document.getElementById('dayModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('dayModal').style.display = 'none';
    }

    function renderModalList() {
        const listDiv = document.getElementById('modalContentList');
        listDiv.innerHTML = '';
        const dayNum = parseInt(currentModalDate.split('-')[2]);

        // 1. æ˜¾ç¤ºå›ºå®šæ”¯å‡º (åªè¯»)
        let hasContent = false;
        store.monthlyFixed.forEach(f => {
            if(f.day === dayNum) {
                hasContent = true;
                listDiv.innerHTML += `
                    <div class="modal-item" style="color:#666">
                        <span>å›ºå®š: ${f.note || 'å®šæœŸæ‰£æ¬¾'}</span>
                        <span>-${f.amt}</span>
                    </div>`;
            }
        });

        // 2. æ˜¾ç¤ºå¹¶ç®¡ç†ä¸´æ—¶è®°å½•
        store.transactions.forEach(t => {
            if(t.date === currentModalDate) {
                hasContent = true;
                listDiv.innerHTML += `
                    <div class="modal-item">
                        <span>${t.note || 'æœªå‘½å'}</span>
                        <span>
                            <b>${t.amt > 0 ? '+' : ''}${t.amt}</b>
                            <span class="del-x" style="color:red; margin-left:10px" onclick="deleteFromModal(${t.id})">âœ•</span>
                        </span>
                    </div>`;
            }
        });

        if(!hasContent) listDiv.innerHTML = `<div style="text-align:center;color:#ccc;font-size:12px;padding:10px">æš‚æ— è®°å½•</div>`;
    }

    function saveFromModal() {
        const amt = parseFloat(document.getElementById('mModAmt').value);
        const note = document.getElementById('mModNote').value;
        if(amt && currentModalDate) {
            store.transactions.push({ id: Date.now(), amt, date: currentModalDate, note });
            renderModalList(); // åˆ·æ–°åˆ—è¡¨
            updateUI(); // åˆ·æ–°èƒŒæ™¯å¤§UI
        }
    }

    function deleteFromModal(id) {
        store.transactions = store.transactions.filter(t => t.id !== id);
        renderModalList();
        updateUI();
    }

    // --- å›¾è¡¨ä¸å¸¸è§„é€»è¾‘ ---
    function renderChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        const totalDays = new Date(y, m + 1, 0).getDate();
        let labels = [], dataPoints = [];
        for(let d=1; d<=totalDays; d++) {
            labels.push(d);
            dataPoints.push(Math.round(getBalanceAtDate(new Date(y, m, d).toLocaleDateString('sv-SE'))));
        }
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ data: dataPoints, borderColor: '#4a90e2', tension: 0.3, pointRadius: 0, fill: false, borderWidth: 2 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { font: { size: 10 } } }, x: { ticks: { font: { size: 10 } } } } }
        });
    }

    function addItem(type) {
        if(type === 'monthly') {
            const amt = parseFloat(document.getElementById('mFixedAmt').value);
            const day = parseInt(document.getElementById('mFixedDay').value);
            const note = document.getElementById('mFixedNote').value;
            if(amt && day) store.monthlyFixed.push({ id: Date.now(), amt, day, note });
        } else {
            const amt = parseFloat(document.getElementById('tAmt').value);
            const date = document.getElementById('tDate').value;
            const note = document.getElementById('tNote').value;
            if(amt && date) store.transactions.push({ id: Date.now(), amt, date, note });
        }
        updateUI();
    }

    function deleteItem(type, id) {
        if(type === 'm') store.monthlyFixed = store.monthlyFixed.filter(i => i.id !== id);
        else store.transactions = store.transactions.filter(i => i.id !== id);
        updateUI();
    }

    function renderLists() {
        document.getElementById('mList').innerHTML = store.monthlyFixed.map(i => `<li><span>${i.day}æ—¥: -${i.amt}</span><span class="del-x" onclick="deleteItem('m',${i.id})">âœ•</span></li>`).join('');
        document.getElementById('tList').innerHTML = store.transactions.slice(-5).reverse().map(i => `<li><span>${i.date.slice(5)}: ${i.amt}</span><span class="del-x" onclick="deleteItem('t',${i.id})">âœ•</span></li>`).join('');
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(store, null, 2)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `cash_flow_backup.json`; a.click();
    }

    function importData(e) {
        const reader = new FileReader();
        reader.onload = (ev) => { store = JSON.parse(ev.target.result); initInputs(); updateUI(); };
        reader.readAsText(e.target.files[0]);
    }

    function initInputs() {
        document.getElementById('baseBalance').value = store.config.baseBalance;
        document.getElementById('baseDate').value = store.config.baseDate;
        document.getElementById('dailyFixed').value = store.config.dailyFixed;
    }

    function changeMonth(step) { viewDate.setMonth(viewDate.getMonth() + step); updateUI(); }

    initInputs();
    updateUI();
</script>

</body>
</html>